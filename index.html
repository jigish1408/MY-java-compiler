<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Java Online IDE + AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        
        body {
            background-color: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background: #424242; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4f4f4f; }

        .output-area {
            font-family: 'JetBrains Mono', monospace;
            white-space: pre-wrap;
            font-size: 0.9rem;
        }

        .markdown-body { color: #d4d4d4; font-size: 0.9rem; line-height: 1.6; }
        .markdown-body pre { background: #2d2d2d; padding: 10px; border-radius: 4px; overflow-x: auto; margin-top: 10px; margin-bottom: 10px; border: 1px solid #444; }
        .markdown-body code { font-family: 'JetBrains Mono', monospace; background: #3c3c3c; padding: 2px 4px; border-radius: 3px; }
        .markdown-body p { margin-bottom: 10px; }

        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3498db;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .apply-fix-btn {
            background-color: #2563eb;
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-top: 8px;
            display: inline-block;
            cursor: pointer;
            font-weight: bold;
        }
        .apply-fix-btn:hover { background-color: #1d4ed8; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- Navbar -->
    <nav class="bg-[#2d2d2d] flex items-center justify-between px-4 py-2 border-b border-[#3e3e3e] h-[50px]">
        <div class="flex items-center gap-3">
            <i class="fa-brands fa-java text-orange-500 text-2xl"></i>
            <span class="font-bold text-lg text-gray-200">Java<span class="text-blue-400">AI</span></span>
        </div>
        
        <div class="flex items-center gap-2">
            <div class="flex bg-[#3c3c3c] rounded p-0.5 mr-2">
                <button onclick="askAI('explain')" class="flex items-center gap-2 px-3 py-1 text-xs text-gray-300 hover:text-white hover:bg-[#4c4c4c] rounded transition" title="Explain Code">
                    <i class="fa-solid fa-lightbulb text-yellow-500"></i> Explain
                </button>
                <div class="w-[1px] bg-[#4c4c4c] my-1"></div>
                <button onclick="askAI('fix')" class="flex items-center gap-2 px-3 py-1 text-xs text-gray-300 hover:text-white hover:bg-[#4c4c4c] rounded transition" title="Fix Bugs">
                    <i class="fa-solid fa-wand-magic-sparkles text-purple-400"></i> Fix
                </button>
            </div>

            <button id="runBtn" onclick="runCode()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-1 rounded text-sm font-semibold transition flex items-center gap-2">
                <i class="fa-solid fa-play"></i> Run
            </button>
        </div>
    </nav>

    <div class="flex flex-1 overflow-hidden">
        
        <div class="w-1/2 flex flex-col border-r border-[#3e3e3e] relative">
            <div class="bg-[#252526] px-4 py-1 text-xs text-gray-400 flex justify-between items-center border-b border-[#3e3e3e]">
                <span class="font-bold">Main.java</span>
            </div>
            <div id="container" class="flex-1 w-full"></div>
        </div>

        <div class="w-1/2 flex flex-col bg-[#1e1e1e]">
            
            <div class="flex border-b border-[#3e3e3e] bg-[#252526]">
                <button onclick="switchTab('console')" id="tab-console" class="px-4 py-1 text-xs font-bold text-white border-b-2 border-blue-500 bg-[#1e1e1e]">
                    <i class="fa-solid fa-terminal mr-1"></i> Console
                </button>
                <button onclick="switchTab('ai')" id="tab-ai" class="px-4 py-1 text-xs font-bold text-gray-400 hover:text-white transition border-b-2 border-transparent">
                    <i class="fa-solid fa-robot mr-1"></i> AI Assistant
                </button>
            </div>

            <div id="view-console" class="flex flex-col flex-1 overflow-hidden">
                <div id="output" class="output-area flex-1 p-4 overflow-y-auto text-gray-300">
                    <div class="text-gray-500 italic">Click "Run" to execute code...</div>
                </div>
                <div class="h-1/4 border-t border-[#3e3e3e] flex flex-col">
                    <div class="bg-[#252526] px-4 py-1 text-xs text-gray-400 font-bold">Standard Input (Stdin)</div>
                    <textarea id="stdin" class="flex-1 bg-[#1e1e1e] text-gray-300 p-2 resize-none focus:outline-none font-mono text-sm border-none" placeholder="Input data..."></textarea>
                </div>
            </div>

            <div id="view-ai" class="hidden flex-col flex-1 overflow-hidden bg-[#1e1e1e] p-4">
                <div id="ai-output" class="markdown-body flex-1 overflow-y-auto">
                    <div class="text-gray-500 italic mt-10 text-center">
                        <i class="fa-solid fa-wand-magic-sparkles text-4xl mb-3 opacity-50"></i><br>
                        Click "Explain" or "Fix" to get help from Gemini AI.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs/loader.min.js"></script>
    <script>
        
        const HARDCODED_JUDGE0_KEY = "f207c19e22msh86880f9c9e46388p15043ajsncd3ae3be9685"; 
        const HARDCODED_GEMINI_KEY = "AIzaSyDQeR-syPFpkUh5FsmScsX6MF1cVpDoab8"; 
        
        let editor;
        let lastAiCode = "";

        const defaultCode = `public class Main {
    public static void main(String[] args) {
        System.out.println("Hello, World!");
        
        // Error for testing "Fix"
        // int x = "oops"; 
    }
}`;

        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs' }});
        require(['vs/editor/editor.main'], function() {
            editor = monaco.editor.create(document.getElementById('container'), {
                value: localStorage.getItem('java_code') || defaultCode,
                language: 'java',
                theme: 'vs-dark',
                automaticLayout: true,
                fontSize: 14,
                minimap: { enabled: false }
            });
            editor.onDidChangeModelContent(() => localStorage.setItem('java_code', editor.getValue()));
        });

        function getKeys() {
            return {
                judge0: HARDCODED_JUDGE0_KEY,
                gemini: HARDCODED_GEMINI_KEY
            };
        }

        function switchTab(tab) {
            const consoleView = document.getElementById('view-console');
            const aiView = document.getElementById('view-ai');
            const consoleBtn = document.getElementById('tab-console');
            const aiBtn = document.getElementById('tab-ai');

            if (tab === 'console') {
                consoleView.classList.remove('hidden');
                aiView.classList.add('hidden');
                consoleBtn.classList.add('border-blue-500', 'text-white');
                consoleBtn.classList.remove('text-gray-400', 'border-transparent');
                aiBtn.classList.remove('border-purple-500', 'text-white');
                aiBtn.classList.add('text-gray-400', 'border-transparent');
            } else {
                consoleView.classList.add('hidden');
                aiView.classList.remove('hidden');
                aiView.classList.add('flex');
                aiBtn.classList.add('border-purple-500', 'text-white');
                aiBtn.classList.remove('text-gray-400', 'border-transparent');
                consoleBtn.classList.remove('border-blue-500', 'text-white');
                consoleBtn.classList.add('text-gray-400', 'border-transparent');
            }
        }

        async function runCode() {
            switchTab('console');
            const btn = document.getElementById('runBtn');
            const out = document.getElementById('output');
            const { judge0 } = getKeys();
            
            if (!judge0) {
                out.innerHTML = '<span class="text-yellow-500">Missing API Key. Please edit the file and paste your Judge0 Key into the code.</span>';
                return; 
            }

            btn.disabled = true;
            btn.innerHTML = '<div class="loader"></div>';
            out.innerHTML = '<span class="text-gray-500">Compiling...</span>';

            try {
                const res = await fetch('https://judge0-ce.p.rapidapi.com/submissions?base64_encoded=true&fields=*', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-RapidAPI-Key': judge0, 'X-RapidAPI-Host': 'judge0-ce.p.rapidapi.com' },
                    body: JSON.stringify({
                        language_id: 62,
                        source_code: btoa(editor.getValue()),
                        stdin: btoa(document.getElementById('stdin').value)
                    })
                });
                
                if (!res.ok) throw new Error("API Error (Check Key or Limits)");
                const { token } = await res.json();
                await pollStatus(token, judge0);
            } catch (e) {
                out.innerHTML = `<span class="text-red-500">${e.message}</span>`;
                resetBtn();
            }
        }

        async function pollStatus(token, key) {
            let status = 1;
            let result;
            while (status <= 2) {
                await new Promise(r => setTimeout(r, 1000));
                const res = await fetch(`https://judge0-ce.p.rapidapi.com/submissions/${token}?base64_encoded=true&fields=*`, {
                    headers: { 'X-RapidAPI-Key': key, 'X-RapidAPI-Host': 'judge0-ce.p.rapidapi.com' }
                });
                result = await res.json();
                status = result.status.id;
            }
            
            const decode = s => s ? atob(s) : "";
            const out = document.getElementById('output');
            out.innerHTML = "";
            
            if (result.compile_output) out.innerHTML += `<div class="text-red-400 font-bold mb-2">Compilation Error:</div>${decode(result.compile_output)}\n`;
            if (result.stdout) out.innerHTML += `<div class="text-green-400 font-bold mb-2">Output:</div>${decode(result.stdout)}\n`;
            if (result.stderr) out.innerHTML += `<div class="text-red-400 font-bold mb-2">Runtime Error:</div>${decode(result.stderr)}\n`;
            
            out.innerHTML += `\n<div class="text-gray-600 text-xs mt-4 border-t border-[#333] pt-2">Time: ${result.time}s | Memory: ${result.memory}KB</div>`;
            resetBtn();
        }

        function resetBtn() {
            const btn = document.getElementById('runBtn');
            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-play"></i> Run';
        }

        async function askAI(mode) {
            const { gemini } = getKeys();

            switchTab('ai');
            const aiDiv = document.getElementById('ai-output');
            
            if (!gemini) {
                aiDiv.innerHTML = '<div class="text-red-400 mt-10 text-center">Missing Gemini API Key. Please edit the file and paste your key into the code.</div>';
                return;
            }

            aiDiv.innerHTML = '<div class="text-center mt-10"><div class="loader"></div><br><span class="text-gray-400 text-sm">Gemini is thinking...</span></div>';

            const code = editor.getValue();
            let prompt = "";
            
            if (mode === 'explain') prompt = `Explain this Java code simply:\n\n${code}`;
            else if (mode === 'fix') prompt = `Find bugs in this Java code. Return ONLY the fixed full Java code inside a markdown block. Then explain briefly.\n\n${code}`;

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${gemini}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await res.json();
                if (data.error) throw new Error(data.error.message);
                
                const responseText = data.candidates[0].content.parts[0].text;
                
                // Extract code block 
                const match = responseText.match(/```java\s*([\s\S]*?)\s*```/);
                if (match && mode === 'fix') {
                    lastAiCode = match[1];
                    aiDiv.innerHTML = marked.parse(responseText);
                    aiDiv.innerHTML += `<button onclick="applyAiFix()" class="apply-fix-btn"><i class="fa-solid fa-check mr-1"></i> Apply Fix to Editor</button>`;
                } else {
                    aiDiv.innerHTML = marked.parse(responseText);
                }

            } catch (e) {
                aiDiv.innerHTML = `<div class="text-red-400">AI Error: ${e.message}</div>`;
            }
        }

        function applyAiFix() {
            if (lastAiCode) {
                editor.setValue(lastAiCode);
                switchTab('console');
                
                const out = document.getElementById('output');
                out.innerHTML = '<span class="text-green-400">Code updated! Run the code to test the fix.</span>';
            }
        }
    </script>
</body>
</html>

